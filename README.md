# Leaning Ansible

## Ansible Up & Running

**NOTE:** There are a variety of bugs in the textbook and they are using Ubuntu and I am using Red Hat which had differences as well.

This majority of this code is a combination of the books [Ansible Up & Running 2nd edition](https://www.oreilly.com/library/view/ansible-up-and/9781491979792/) and the [3rd edition](https://www.oreilly.com/library/view/ansible-up-and/9781098109141/). They are both excellent resources to learn Ansible with and the code for them is available at https://github.com/ansiblebook and additional resources at https://oreil.ly/ansible-3e.

At the time of doing the 3rd edition textbook I created a Python 3.10.9 virtual environment with Ansible 7.1 and Ansible Core 2.14.1.

```bash
# Create Python virtual environment and load it
python -m venv .venv --prompt ansible-up-and-running
source .venv/bin/activate

# Upgrade pip
pip install --upgrade pip

# Install Ansible
pip install ansible
```

```
Collecting ansible
  Downloading ansible-7.1.0-py3-none-any.whl (42.4 MB)
     |████████████████████████████████| 42.4 MB 13.1 MB/s
Collecting ansible-core~=2.14.1
  Downloading ansible_core-2.14.1-py3-none-any.whl (2.2 MB)
     |████████████████████████████████| 2.2 MB 12.3 MB/s
Collecting packaging
  Downloading packaging-23.0-py3-none-any.whl (42 kB)
     |████████████████████████████████| 42 kB 1.3 MB/s
Collecting jinja2>=3.0.0
  Downloading Jinja2-3.1.2-py3-none-any.whl (133 kB)
     |████████████████████████████████| 133 kB 52.2 MB/s
Collecting cryptography
  Downloading cryptography-39.0.0-cp36-abi3-manylinux_2_28_x86_64.whl (4.2 MB)
     |████████████████████████████████| 4.2 MB 124.0 MB/s
Collecting PyYAML>=5.1
  Downloading PyYAML-6.0-cp310-cp310-manylinux_2_5_x86_64.manylinux1_x86_64.manylinux_2_12_x86_64.manylinux2010_x86_64.whl (682 kB)
     |████████████████████████████████| 682 kB 16.0 MB/s
Collecting resolvelib<0.9.0,>=0.5.3
  Downloading resolvelib-0.8.1-py2.py3-none-any.whl (16 kB)
Collecting MarkupSafe>=2.0
  Downloading MarkupSafe-2.1.2-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (25 kB)
Collecting cffi>=1.12
  Downloading cffi-1.15.1-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (441 kB)
     |████████████████████████████████| 441 kB 64.8 MB/s
Collecting pycparser
  Downloading pycparser-2.21-py2.py3-none-any.whl (118 kB)
     |████████████████████████████████| 118 kB 61.0 MB/s
Installing collected packages: pycparser, MarkupSafe, cffi, resolvelib, PyYAML, packaging, jinja2, cryptography, ansible-core, ansible
Successfully installed MarkupSafe-2.1.2 PyYAML-6.0 ansible-7.1.0 ansible-core-2.14.1 cffi-1.15.1 cryptography-39.0.0 jinja2-3.1.2 packaging-23.0 pycparser-2.21 resolvelib-0.8.1

```

### Vagrant

I installed the `vagrant` version included with Fedora 36 which is 2.2.19 and I installed the following plugins:

* `vagrant-libvirt` so I can use qemu/kvm.
* `vagrant-hostmanager` so Vagrant manages multiple hosts automatically.

#### SSH Bug

There seems to be a bug with the SSH key protocl ed25519. This is not supported by the internal Vagrant SSH component. The only way I could get around this was to use the default RSA keys generated by Vagrant. These replace the default insecure keys. The ed25519 bug still comes into play after a `vagrant halt`. Basically I have to reload all SSH keys via `ssh-add -D` in my SSH agent for it to go away.

Terminal window 1.

```
(ansible-up-and-running) [dallas@desktop ansible-up-and-running] $ vagrant halt
File exists: /home/dallas/Development/personal/learning/ansible/ansible-up-and-running/./config.rb
==> almalinux-9-vm-01: Clearing any previously set forwarded ports...
==> almalinux-9-vm-01: Attempting graceful shutdown of VM...
    almalinux-9-vm-01: Guest communication could not be established! This is usually because
    almalinux-9-vm-01: SSH is not running, the authentication information was changed,
    almalinux-9-vm-01: or some other networking issue. Vagrant will force halt, if
    almalinux-9-vm-01: capable.
==> almalinux-9-vm-01: Attempting direct shutdown of domain...
(ansible-up-and-running) [dallas@desktop ansible-up-and-running] $ vagrant up
File exists: /home/dallas/Development/personal/learning/ansible/ansible-up-and-running/./config.rb
Bringing machine 'almalinux-9-vm-01' up with 'libvirt' provider...
==> almalinux-9-vm-01: Checking if box 'almalinux/9' version '9.1.20221117' is up to date...
==> almalinux-9-vm-01: Starting domain.
==> almalinux-9-vm-01: Waiting for domain to get an IP address...
==> almalinux-9-vm-01: Waiting for machine to boot. This may take a few minutes...
    almalinux-9-vm-01: SSH address: 192.168.121.181:22
    almalinux-9-vm-01: SSH username: vagrant
    almalinux-9-vm-01: SSH auth method: private key
    almalinux-9-vm-01: Warning: Authentication failure. Retrying...
```

Termianl window 2.

```bash
# In another terminal
ssh-add -D
```

```
All identities removed.
```

Termianl window 1.

```
==> almalinux-9-vm-01: Machine booted and ready!
==> almalinux-9-vm-01: Creating shared folders metadata...
==> almalinux-9-vm-01: Forwarding ports...
==> almalinux-9-vm-01: 80 (guest) => 8080 (host) (adapter eth0)
==> almalinux-9-vm-01: 443 (guest) => 8443 (host) (adapter eth0)
==> almalinux-9-vm-01: Rsyncing folder: /home/dallas/Development/personal/learning/ansible/ansible-up-and-running/ => /vagrant
vagrant@192.168.121.181's password:
==> almalinux-9-vm-01: Machine already provisioned. Run `vagrant provision` or use the `--provision`
==> almalinux-9-vm-01: flag to force provisioning. Provisioners marked to run always will still run.
```

### Exercise Commands

```bash
# Set up environment
cd /home/dallas/Development/personal/learning/ansible/ansible-up-and-running
export ANSIBLE_ROLES_PATH=/home/dallas/Development/personal/learning/ansible/galaxy-roles
export ANSIBLE_INVENTORY=/home/dallas/Development/personal/learning/ansible/ansible-up-and-running/inventories/hosts.yml
export VAGRANT_DEFAULT_PROVIDER=libvirt

# Build VM
vagrant up
```

Enter the password `vagrant` and wait for the Ansible provisioning to finish.

**NOTE:** Remember the [SSH bug.](#ssh-bug)

```bash
# Deploy and text NGINX example
ansible-playbook -i inventories/hosts.yml playbooks/nginx-playbook.yml
curl localhost:8080
```

```html
<html>
  <head>
    <title>Welcome to ansible</title>
  </head>
  <body>
    <h1>Nginx, configured by Ansible</h1>
    <p>If you can see this, Ansible successfully installed nginx.</p>
    <p>Running on almalinux9</p>
  </body>
</html>
```

```bash
# Create TLS certificate
openssl req -x509 -nodes -days 365 -newkey rsa:4096 -subj '/CN=localhost' -keyout playbooks/files/nginx.key -out playbooks/files/nginx.crt


# Install Ansible Lint for YAML checking
pip install ansible-lint
```

**NOTE:** I faced problems getting NGINX to work with SSL because the certificate information from the book was for Debian and I am using Red Hat. Once I changed to the Red Hat way it worked correctly.

**NOTE:** I also faced problems after rebooting the VM. The port forwarding configuration is lost. To fix this just run `vagrant reload`.

```bash
# Deploy Nginx
ansible-playbook -i inventories/hosts.yml playbooks/nginx-deployment.yml

# Test HTTP and HTTPS
curl http://localhost:8080
curl -k https://localhost:8443
```
Both commands returned:

```html
<html>
  <head>
    <title>Welcome to ansible</title>
  </head>
  <body>
    <h1>Nginx, configured by Ansible</h1>
    <p>If you can see this, Ansible successfully installed nginx.</p>
    <p>Running on almalinux9</p>
  </body>
</html>
```